<!DOCTYPE html>
<html>
<head>
	<title>GDC-transcript</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style>
		body {
			margin: 0;
			padding: 0;
		}
		.container {
			position: relative;
			height: 100vh;
			width: 100vw;
		}
		.input-container {
			top: 0;
			left: 0;
			width: 100%;
			background-color: #f5f5f5;
			display: flex;
			align-items: center;
			justify-content: center;
		}
        .input-text {
            margin: 10px;
        }
        #subtitle-status  {
            top: 0;
			left: 0;
			width: 100%;
			background-color: #f5f5f5;
			display: flex;
			align-items: center;
			justify-content: center;
        }
		#video {
			width: 100%;
			height: 100%;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="input-container">
            <input class="input-text" id="video-id" type="text" placeholder="Enter youtube id">
            <button id="button-goto">Go</button>
		</div>
        <div id="subtitle-status"></div>
        <div class="toolbar-contianer">

        </div>

        <div id="video"></div>
		<!-- <iframe id="video" src="https://www.youtube.com/embed/c2YRVWZupwo" frameborder="0" allowfullscreen></iframe> -->
	</div>
	<script src="static/vendor/youtube.external.subtitle/youtube.external.subtitle.js"></script>
	<script src="static/vendor/subtitles-parser/subtitles.parser.min.js"></script>
	<script>
        const ParamVideoId = 'v';
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const videoId = urlParams.get(ParamVideoId);

        var RedirectByVideoId = function (videoId) {
            const parser = new URL(window.location);
            parser.searchParams.set(ParamVideoId, videoId);
            window.location = parser.href;
        }

        if (!videoId) {
            // Homepage redirects to Portal GDC for the moment.
            RedirectByVideoId("c2YRVWZupwo");
        }
        
        let inputVideoId = document.getElementById('video-id');
        let buttonGoto = document.getElementById('button-goto');
        inputVideoId.value = videoId;
        buttonGoto.addEventListener('click', function() {
            RedirectByVideoId(inputVideoId.value);
        });

        let elementVideo = document.getElementById('video');
        let youtubeEmbed = document.createElement('iframe');
        elementVideo.replaceWith(youtubeEmbed);
        youtubeEmbed.id = 'video';
        youtubeEmbed.src = `https://www.youtube.com/embed/${videoId}`;
        youtubeEmbed.frameBorder = 0;
        youtubeEmbed.allowFullscreen = true;

        let elementSubtitleStatus = document.getElementById('subtitle-status');

		var LoadSRT = function (url, callback) {
			const httpRequest = new XMLHttpRequest();

			httpRequest.onreadystatechange = function () {
				if (httpRequest.readyState === XMLHttpRequest.DONE) {
                    if (httpRequest.status === 200) {
                        let subtitles = parser.fromSrt(httpRequest.responseText, true);
                        
                        for (let i in subtitles) {
                            subtitles[i] = {
                                start: subtitles[i].startTime / 1000,
                                end: subtitles[i].endTime / 1000,
                                text: subtitles[i].text
                            };
                        }
                        callback(subtitles);
                    } else {
                        console.log("Response status: " + httpRequest.status);
                        document.getElementById('subtitle-status').innerHTML = `No subtitle for this video. &nbsp <a href="https://github.com/dklassic/GDC-transcript/issues">[Request subtitle]</a>`
                    }
				}
			};

			httpRequest.open('GET', url, true);
			httpRequest.send(null);
		};
        
		LoadSRT(`static/src/subtitle/${videoId}.srt`, function (subtitles) {
			const youtubeExternalSubtitle = new YoutubeExternalSubtitle.Subtitle(document.getElementById('video'), subtitles);
		});
	</script>
    <script>
        
    </script>
</body>
</html>
